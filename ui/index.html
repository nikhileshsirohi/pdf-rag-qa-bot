<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>PDF RAG QA Bot</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    label { font-weight: 600; }
    select, input, textarea, button { padding: 8px; margin-top: 6px; }
    textarea { width: 600px; max-width: 100%; }
    .row { margin: 12px 0; }
    .hint { color: #666; font-size: 12px; margin-top: 4px; }
    .error { color: #b00020; font-weight: 600; white-space: pre-wrap; }
    .success { color: #0b6b0b; font-weight: 600; white-space: pre-wrap; }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .box { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: fit-content; max-width: 100%; }
    pre { background: #f7f7f7; padding: 12px; border-radius: 8px; border: 1px solid #eee; }
  </style>
</head>
<body>

<h2>PDF RAG QA Bot</h2>

<div class="box">

  <div class="row">
    <label>Choose Model Provider:</label><br/>
    <select id="provider">
      <option value="huggingface">Hugging Face (google/flan-t5-base)</option>
      <option value="openai">OpenAI</option>
      <option value="gemini">Gemini</option>
    </select>
    <div class="hint">OpenAI/Gemini require an API key. Hugging Face here is assumed local/no key.</div>
  </div>

  <div class="row">
    <label>API Key:</label><br/>
    <input type="password" id="apiKey" placeholder="Paste API key (required for OpenAI/Gemini)" disabled />
    <div class="hint" id="apiKeyHint"></div>
  </div>

  <div class="row">
    <label>Model Name:</label><br/>
    <select id="model"></select>
    <div class="hint" id="modelHint"></div>
  </div>

  <div class="row">
    <label>Your Question:</label><br/>
    <textarea id="question" rows="5" cols="60" placeholder="Ask a question..."></textarea>
  </div>

  <div class="row">
    <button id="askBtn" onclick="askQuestion()" disabled>Ask</button>
    <span id="status" class="hint" style="margin-left:10px;"></span>
  </div>

  <div class="row">
    <div id="uiError" class="error"></div>
  </div>

</div>

<h3>Answer:</h3>
<pre id="answer"></pre>

<script>
  // Simple defaults; adjust to match your backend/provider support.
const MODELS = {
  huggingface: [
    { value: "", label: "Default (google/flan-t5-base)" }
  ],
  openai: [
    { value: "gpt-4o-mini", label: "gpt-4o-mini (cheap/fast)" },
    { value: "gpt-4o", label: "gpt-4o (stronger)" }
  ],
  gemini: [
    { value: "models/gemini-flash-lite-latest", label: "Gemini Flash-Lite Latest (fastest)" },
    { value: "models/gemini-flash-latest", label: "Gemini Flash Latest (fast)" },
    { value: "models/gemini-pro-latest", label: "Gemini Pro Latest (stronger)" },
    ],
};

  const providerEl = document.getElementById("provider");
  const apiKeyEl = document.getElementById("apiKey");
  const modelEl = document.getElementById("model");
  const questionEl = document.getElementById("question");
  const askBtn = document.getElementById("askBtn");
  const uiErrorEl = document.getElementById("uiError");
  const answerEl = document.getElementById("answer");
  const statusEl = document.getElementById("status");
  const apiKeyHintEl = document.getElementById("apiKeyHint");
  const modelHintEl = document.getElementById("modelHint");

  function requiresApiKey(provider) {
    return provider === "openai" || provider === "gemini";
  }

  function setError(msg) {
    uiErrorEl.textContent = msg || "";
  }

  function setStatus(msg) {
    statusEl.textContent = msg || "";
  }

  function setAnswer(msg) {
    answerEl.textContent = msg || "";
  }

  function fillModelDropdown(provider) {
    modelEl.innerHTML = "";
    const items = MODELS[provider] || [{ value: "", label: "Default" }];

    for (const item of items) {
      const opt = document.createElement("option");
      opt.value = item.value;
      opt.textContent = item.label;
      modelEl.appendChild(opt);
    }

    // Optional hints
    if (provider === "huggingface") {
      modelHintEl.textContent = "Using local/default HF model unless your backend supports changing it.";
    } else if (provider === "openai") {
      modelHintEl.textContent = "Choose an OpenAI model. Make sure your API key has access/billing enabled.";
    } else if (provider === "gemini") {
      modelHintEl.textContent = "Choose a Gemini model. Make sure your key is valid for the Gemini API.";
    } else {
      modelHintEl.textContent = "";
    }
  }

  function validateForm() {
    const provider = providerEl.value;
    const question = questionEl.value.trim();
    const needsKey = requiresApiKey(provider);
    const apiKey = apiKeyEl.value.trim();

    // Enable/disable API key field
    apiKeyEl.disabled = !needsKey;

    if (!needsKey) {
      apiKeyHintEl.textContent = "";
    } else {
      apiKeyHintEl.textContent = "API key is mandatory for OpenAI/Gemini.";
    }

    // Button rules:
    // - must have question
    // - if provider needs key, must have key
    let valid = true;
    let msg = "";

    if (!question) {
      valid = false;
      msg = "Type a question to enable Ask.";
    } else if (needsKey && !apiKey) {
      valid = false;
      msg = "API key is mandatory for OpenAI/Gemini.";
    }

    askBtn.disabled = !valid;
    setStatus(msg);
  }

  providerEl.addEventListener("change", () => {
    setError("");
    setAnswer("");
    fillModelDropdown(providerEl.value);
    validateForm();
  });

  apiKeyEl.addEventListener("input", validateForm);
  questionEl.addEventListener("input", validateForm);

  // Initialize UI on load
  fillModelDropdown(providerEl.value);
  validateForm();

  async function askQuestion() {
    setError("");
    setStatus("Sending request...");
    setAnswer("");

    const provider = providerEl.value;
    const question = questionEl.value.trim();
    const needsKey = requiresApiKey(provider);
    const apiKey = apiKeyEl.value.trim();
    const model = modelEl.value || null;

    // Final guard (in case user bypasses disabled button)
    if (!question) {
      setStatus("");
      setError("Question is required.");
      return;
    }
    if (needsKey && !apiKey) {
      setStatus("");
      setError("API key is mandatory for OpenAI/Gemini.");
      return;
    }

    askBtn.disabled = true;

    try {
      const payload = {
        question,
        provider,
        api_key: needsKey ? apiKey : null,
        model: model || null
      };

      const response = await fetch("http://127.0.0.1:8000/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      // If backend returns non-2xx, show error body nicely
      if (!response.ok) {
        let errText = `Request failed (${response.status})`;
        try {
          const errJson = await response.json();
          // FastAPI typically returns: { detail: ... }
          if (typeof errJson.detail === "string") errText = errJson.detail;
          else if (errJson.detail) errText = JSON.stringify(errJson.detail, null, 2);
          else errText = JSON.stringify(errJson, null, 2);
        } catch (_) {
          // maybe plain text
          const raw = await response.text();
          if (raw) errText = raw;
        }

        // Common “payment / key” hints (pure UI; actual message comes from backend)
        const hint =
          (provider === "openai")
            ? "\n\nIf this is an API key/billing issue: check key validity + billing/payment method in your OpenAI account."
            : (provider === "gemini")
              ? "\n\nIf this is an API key issue: verify the key is for Gemini API and enabled in Google Cloud / AI Studio."
              : "";

        setError(errText + hint);
        setStatus("");
        return;
      }

      const data = await response.json();
      setAnswer(data.answer ?? "(No answer field returned)");
      setStatus("Done.");
    } catch (err) {
      setError("Network error: " + (err?.message || String(err)));
      setStatus("");
    } finally {
      askBtn.disabled = false; // validateForm will re-disable if needed
      validateForm();
    }
  }
</script>

</body>
</html>